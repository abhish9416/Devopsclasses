---
- name : install tomcat 10 on ubuntu 22.04
  hosts: all
  become : yes
  vars :
    java_package_name : openjdk-11-jdk
    owner_name : tomcat
    group_name : tomcat
    
  tasks:
    - name : Java installation
      ansible.builtin.apt: 
        name : "{{ java_package_name }}"
        update_cache: yes 
        state: present
    - name : create a tomcat group
      ansible.builtin.group :
        name : tomcat
        state : present
    - name : Create a tomcat user
      ansible.builtin.user:
        name : tomcat
        create_home : yes
        group : "{{ group_name }}"
        home : /opt/tomcat
        shell : /bin/false
        state : present
    # - name : download tomcat on ubuntu
    #   ansible.builtin.get_url :
    #     url : https://www-eu.apache.org/dist/tomcat/tomcat-10/v10.0.27/bin/apache-tomcat-10.0.27.tar.gz
    #     dest : /tmp/apache-tomcat-10.0.27.tar.gz
    - name : Extract /tmp/apache-tomcat-10.0.27
      ansible.builtin.unarchive :
        src : https://www-eu.apache.org/dist/tomcat/tomcat-10/v10.0.27/bin/apache-tomcat-10.0.27.tar.gz
        dest : /opt/tomcat/
        remote_src : yes
    - name : create a symbolic link for tomcat
      ansible.builtin.file :
        src : /opt/tomcat/apache-tomcat-10.0.27
        dest : /opt/tomcat/latest
        state : link
    - name : change permission
      ansible.builtin.file:
        dest : /opt/tomcat/
        recurse : yes
        owner : "{{ owner_name }}"
        group : "{{ group_name }}"
        state : directory
    - name : add execute permission for the shell files
      ansible.builtin.command : sudo sh -c 'chmod +x /opt/tomcat/latest/bin/*.sh'
    - name : create a system Dunit file for tomcat
      ansible.builtin.copy :
        src : tomcat.service
        dest : /etc/systemd/system/tomcat.service
        owner : "{{ owner_name }}"
        group : "{{ group_name }}"
    - name : Demon Reload
      ansible.builtin.systemd :
        name : tomcat.service
        daemon_reload : yes
        enabled : yes
        state : started
    - name : copy the user xml
      ansible.builtin.copy :
        src : tomcat-users.xml
        dest : /opt/tomcat/latest/conf/tomcat-users.xml 
        owner : "{{ owner_name }}"
        group : "{{ group_name }}"
    - name : copy the context.xml
      ansible.builtin.copy :
        src : context.xml
        dest : /opt/tomcat/latest/webapps/manager/META-INF/context.xml
        owner : "{{ owner_name }}"
        group : "{{ group_name }}"
    - name : copy the hostmanager xml
      ansible.builtin.copy :
        src : hostmanager-context.xml
        dest : /opt/tomcat/latest/webapps/host-manager/META-INF/context.xml
        owner : "{{ owner_name }}"
        group : "{{ group_name }}"
    - name : restart tomcat
      ansible.builtin.systemd :
        name : tomcat.service
        state : restarted